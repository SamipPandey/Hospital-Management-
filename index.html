<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMS Enterprise v19.0 - Absolute Financial Integrity</title>
    
    <!-- 
        ==================================================================================
        EXTERNAL RESOURCES: CHART ENGINE & HIGH-FIDELITY TYPOGRAPHY
        ==================================================================================
    -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* 
           ==================================================================================
           LIQUID GLASS DESIGN SYSTEM (Inspired by iOS 26 & VisionOS)
           ==================================================================================
        */
        :root {
            /* Palette Architecture */
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            
            /* Glassmorphism Coefficients */
            --glass: rgba(255, 255, 255, 0.03);
            --glass-thick: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-blur: blur(25px) saturate(200%);
            
            /* Typography & Layout */
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --text-v-dim: #64748b;
            --sidebar-width: 300px;
            
            /* Motion Curves */
            --trans-smooth: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            --trans-spring: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* 
           --- PRINT ARCHITECTURE --- 
           Strips all UI elements for professional invoice output.
        */
        @media print {
            body { background: white !important; color: black !important; overflow: visible !important; }
            #sidebar, .btn-primary, .no-print, #toast-container, .sidebar-brand, .section-header, .search-container, #loginOverlay { display: none !important; }
            #main { padding: 0 !important; margin: 0 !important; width: 100% !important; overflow: visible !important; }
            .card, .glass-panel { border: none !important; backdrop-filter: none !important; box-shadow: none !important; background: transparent !important; color: black !important; padding: 0 !important; }
            .content-sec { display: none !important; }
            #receiptModal { display: flex !important; background: white !important; position: static !important; width: 100% !important; justify-content: flex-start !important; padding: 0 !important; }
            .receipt-card { width: 100% !important; border: none !important; box-shadow: none !important; padding: 0 !important; color: black !important; font-family: 'Courier New', Courier, monospace; }
            .no-print-btn { display: none !important; }
        }

        /* 
           --- BASE RESET & SMOOTHING --- 
        */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
        }

        /* 
           --- NOTIFICATION ENGINE (Toasts) --- 
        */
        #toast-container {
            position: fixed;
            top: 40px;
            right: 40px;
            z-index: 100000;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toast {
            padding: 18px 28px;
            border-radius: 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            color: white;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            transform: translateX(150%);
            animation: toastIn 0.8s var(--trans-spring) forwards;
        }

        @keyframes toastIn { to { transform: translateX(0); } }
        .toast.success { border-left: 8px solid var(--success); }
        .toast.danger { border-left: 8px solid var(--danger); }
        .toast.info { border-left: 8px solid var(--accent); }

        /* 
           --- LOGIN ARCHITECTURE (Frosted Look) --- 
        */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background: url('https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d?auto=format&fit=crop&q=80&w=2000') center/cover;
            z-index: 20000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #loginOverlay::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(10, 15, 30, 0.85);
            backdrop-filter: blur(12px);
        }

        .login-box {
            position: relative;
            background: var(--glass);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            padding: 60px;
            border-radius: 32px;
            width: 480px;
            text-align: center;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.7);
            z-index: 5;
        }

        .login-box h2 { font-size: 36px; margin-bottom: 8px; font-weight: 800; color: #fff; letter-spacing: -1.5px; }
        .login-box p { color: var(--text-dim); margin-bottom: 40px; font-size: 15px; }

        /* 
           --- FORM INPUTS & INTERACTIVE ELEMENTS --- 
        */
        input, select, textarea {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            color: white;
            font-family: inherit;
            font-size: 15px;
            outline: none;
            transition: var(--trans-smooth);
        }

        input:focus, select:focus, textarea:focus { 
            border-color: var(--accent); 
            background: rgba(0, 0, 0, 0.6); 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); 
        }

        .btn-primary {
            padding: 18px 28px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #1d4ed8);
            color: white;
            width: 100%;
            font-size: 16px;
            margin-top: 15px;
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.4);
            transition: var(--trans-spring);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.6); 
        }

        .btn-primary:active { transform: scale(0.96); }

        /* 
           --- SIDEBAR ARCHITECTURE --- 
        */
        #sidebar {
            width: var(--sidebar-width);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: var(--glass-blur);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: var(--trans-smooth);
        }

        .sidebar-brand {
            padding: 50px 35px;
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-item {
            padding: 18px 30px;
            cursor: pointer;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            font-weight: 600;
            gap: 15px;
            font-size: 15px;
            border-left: 4px solid transparent;
            transition: var(--trans-smooth);
        }

        .nav-item:hover { 
            background: rgba(255, 255, 255, 0.04); 
            color: #fff; 
            padding-left: 40px;
        }

        .active-nav { 
            background: rgba(59, 130, 246, 0.1) !important; 
            color: var(--accent) !important; 
            border-left: 4px solid var(--accent) !important; 
            font-weight: 800;
        }

        /* 
           --- VIEWPORT & CONTENT SECTIONS --- 
        */
        #main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 60px; 
            background: transparent; 
            scroll-behavior: smooth;
        }

        .content-sec {
            animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card { 
            background: var(--glass); 
            border: 1px solid var(--glass-border); 
            padding: 40px; 
            border-radius: 28px; 
            margin-bottom: 35px; 
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 35px; }
        .stat-val { font-size: 48px; font-weight: 800; margin: 15px 0; color: #fff; font-family: 'JetBrains Mono', monospace; letter-spacing: -2px; }

        /* 
           --- DATA TABLES --- 
        */
        table { width: 100%; border-collapse: separate; border-spacing: 0 12px; margin-top: 25px; }
        th { text-align: left; color: var(--text-dim); padding: 15px 20px; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; font-weight: 900; }
        td { padding: 22px 20px; background: rgba(255, 255, 255, 0.03); font-weight: 500; }
        td:first-child { border-radius: 18px 0 0 18px; }
        td:last-child { border-radius: 0 18px 18px 0; }
        tr:hover td { background: rgba(255, 255, 255, 0.06); }

        /* 
           --- UTILITY CLASSES --- 
        */
        .audit-log {
            background: #020617;
            color: #22c55e;
            font-family: 'JetBrains Mono', monospace;
            padding: 25px;
            height: 250px;
            overflow-y: auto;
            border-radius: 20px;
            font-size: 13px;
            border: 1px solid var(--glass-border);
            line-height: 1.6;
        }

        .hidden { display: none !important; }

        .search-container input { 
            padding: 25px 40px; 
            font-size: 20px; 
            height: 75px; 
            border-radius: 24px; 
            background: rgba(255, 255, 255, 0.05); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        /* 
           --- GALLERY ARCHITECTURE --- 
        */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .gallery-item { border-radius: 20px; overflow: hidden; border: 1px solid var(--glass-border); height: 220px; position: relative; transition: var(--trans-spring); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 1s var(--trans-smooth); opacity: 0.9; }
        .gallery-item:hover img { transform: scale(1.15); opacity: 1; }
        .gallery-label { position: absolute; bottom: 15px; left: 15px; background: rgba(0, 0, 0, 0.7); padding: 8px 15px; border-radius: 10px; font-size: 11px; font-weight: 800; letter-spacing: 1px; }

        /* 
           --- RECEIPT MODAL --- 
        */
        #receiptModal {
            position: fixed; inset: 0; z-index: 50000;
            background: rgba(0, 0, 0, 0.92); backdrop-filter: blur(25px);
            display: none; align-items: center; justify-content: center;
        }
        .receipt-card {
            background: white; color: black; width: 550px; padding: 60px; border-radius: 40px;
            box-shadow: 0 50px 120px rgba(0,0,0,0.8);
            font-family: 'JetBrains Mono', monospace;
        }

        /* 
           --- MOBILE RESPONSIVITY --- 
        */
        @media (max-width: 1024px) {
            #sidebar { width: 85px; }
            .nav-item span { display: none; }
            .nav-item { justify-content: center; padding: 25px 0; }
            .grid-3 { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: auto; flex-direction: row; border-right: none; border-bottom: 1px solid var(--glass-border); overflow-x: auto; }
            .sidebar-brand { display: none; }
            .nav-item { margin: 0; border-left: none; border-bottom: 4px solid transparent; }
            #main { padding: 30px; }
            .grid-3 { grid-template-columns: 1fr; }
            .login-box { width: 90%; padding: 40px 20px; }
        }

    </style>
</head>
<body>

<!-- GLOBAL NOTIFICATION LAYER -->
<div id="toast-container"></div>

<!-- DIGITAL RECEIPT MODAL -->
<div id="receiptModal">
    <div class="receipt-card">
        <h2 style="font-weight: 900; border-bottom: 3px solid #f1f5f9; padding-bottom: 20px; letter-spacing: -2px;">HMS ENTERPRISE INVOICE</h2>
        <div id="receiptPayload" style="margin: 40px 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap; color: #334155;"></div>
        <div style="display: flex; gap: 15px;" class="no-print">
            <button class="btn-primary" style="flex: 1; background: #0f172a;" onclick="window.print()">PRINT INVOICE</button>
            <button class="btn-primary" style="flex: 1; background: var(--danger);" onclick="closeReceipt()">CLOSE</button>
        </div>
    </div>
</div>

<!-- AUTHENTICATION OVERLAY -->
<div id="loginOverlay">
    <div class="login-box">
        <div style="font-size: 70px; margin-bottom: 25px; filter: drop-shadow(0 0 20px var(--accent));">üè•</div>
        <h2>HMS Enterprise</h2>
        <p>Terminal v19.0 | Credential Verification</p>
        <input type="text" id="userIn" placeholder="Terminal Username">
        <input type="password" id="passIn" placeholder="Secure Password">
        <button class="btn-primary" onclick="handleLogin()">Establish Secure Link</button>
        <p id="loginMsg" style="color:var(--danger); font-size: 13px; margin-top: 25px; font-weight: 800;"></p>
    </div>
</div>

<!-- SIDEBAR NAVIGATION ENGINE -->
<div id="sidebar" class="hidden">
    <div class="sidebar-brand">
        <h3 id="displayUser" style="margin: 0; font-size: 22px; font-weight: 800; letter-spacing: -1px; color: #fff;">System User</h3>
        <small id="displayRole" style="color: var(--accent); font-weight: 900; letter-spacing: 2px; font-size: 10px; text-transform: uppercase;">VERIFYING...</small>
    </div>
    
    <div style="flex: 1; padding-top: 20px; overflow-y: auto;">
        <div class="nav-item sec-admin role-admin role-doctor active-nav" id="nav-dash" onclick="nav('dashSec', this)">üìä <span>System Analytics</span></div>
        <div class="nav-item sec-admin role-admin" id="nav-staff" onclick="nav('staffSec', this)">üë®‚Äç‚öïÔ∏è <span>Human Resources</span></div>
        <div class="nav-item sec-doc-admin role-admin role-doctor" id="nav-admit" onclick="nav('admitSec', this)">üõå <span>Patient Intake</span></div>
        <div class="nav-item sec-pharma-admin role-admin role-pharmacist" id="nav-pharma" onclick="nav('pharmaSec', this)">üíä <span>Drug Inventory</span></div>
        <div class="nav-item sec-admin role-admin role-doctor" id="nav-lab" onclick="nav('labSec', this)">üî¨ <span>Laboratory</span></div>
        <div class="nav-item sec-admin role-admin" id="nav-finance" onclick="nav('financeSec', this)">üí∞ <span>Revenue & GST</span></div>
        <div class="nav-item role-admin role-doctor role-pharmacist role-patient" id="nav-search" onclick="nav('patientPortalSec', this)">üîç <span>My Medical Bill</span></div>
        <div class="nav-item role-admin role-doctor role-patient" id="nav-features" onclick="nav('featureSec', this)">‚ú® <span>Hospital Features</span></div>
        <div class="nav-item role-admin role-doctor role-patient" id="nav-gallery" onclick="nav('gallerySec', this)">üñºÔ∏è <span>Hospital Gallery</span></div>
        <div class="nav-item role-admin role-doctor" id="nav-game" onclick="nav('gameSec', this)">üéÆ <span>Staff Break Room</span></div>
    </div>

    <button class="btn-primary" style="margin: 30px; background: var(--danger); border-radius: 20px; width: calc(100% - 60px);" onclick="logout()">üö™ Exit Terminal</button>
</div>

<!-- MAIN VIEWPORT ENGINE -->
<div id="main" class="hidden">
    
    <!-- DASHBOARD SECTION -->
    <div id="dashSec" class="content-sec">
        <div class="section-header">
            <h2 style="font-size: 38px; margin-top: 0; font-weight: 800; letter-spacing: -2px;">System Analytics Matrix</h2>
            <p style="color: var(--text-dim); margin-bottom: 40px;">Real-time Facility Telemetry & Resource Tracking</p>
        </div>
        
        <div class="grid-3">
            <div class="card stat-card">
                <small style="color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; font-weight: 800;">Global Admissions</small>
                <div class="stat-val" id="stat-p">0</div>
                <div style="color: var(--success); font-size: 13px; font-weight: 800;">‚Üë 8.4% Efficiency</div>
            </div>
            <div class="card stat-card">
                <small style="color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; font-weight: 800;">Bed Occupancy</small>
                <div class="stat-val" id="stat-b">50</div>
                <div style="color: var(--warning); font-size: 13px; font-weight: 800;">Active Resource Tracking</div>
            </div>
            <div class="card stat-card">
                <small style="color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; font-weight: 800;">Net Revenue Flow</small>
                <div class="stat-val" id="stat-profit">Rs 0</div>
                <div style="color: var(--accent); font-size: 13px; font-weight: 800;">Post-Tax Calculation</div>
            </div>
        </div>

        <div class="card">
            <h3>Revenue Growth Trajectory</h3>
            <canvas id="revenueChart" height="110" style="margin-top: 20px;"></canvas>
        </div>

        <div class="card">
            <h3>Terminal Security Audit Log</h3>
            <div id="auditContainer" class="audit-log" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- HR SECTION -->
    <div id="staffSec" class="content-sec hidden">
        <div class="card">
            <h2>Add New Medical Professional</h2>
            <div class="grid-3" style="margin-top: 30px;">
                <input type="text" id="stName" placeholder="Full Professional Name">
                <select id="stRole" onchange="toggleStaffFields()">
                    <option value="Doctor">Senior Specialist</option>
                    <option value="Senior Surgeon">Senior Surgeon</option>
                    <option value="Nurse">Medical Nurse</option>
                    <option value="Pharmacist">Lead Pharmacist</option>
                    <option value="Security">Security Personnel</option>
                </select>
                <input type="number" id="stSalary" placeholder="Monthly Base Salary (Rs)">
            </div>
            <div id="doctorSpecificInputs" class="grid-3">
                <input type="number" id="stConsultCharge" placeholder="Consultation Charge (Rs)">
            </div>
            <button class="btn-primary" style="width: auto; margin-top: 10px;" onclick="addStaff()">Commit Record</button>
        </div>
        <div class="card">
            <h3>Human Resources Roster (Payroll Overview)</h3>
            <div id="staffList"></div>
        </div>
    </div>

    <!-- PATIENT BILLING PORTAL -->
    <div id="patientPortalSec" class="content-sec hidden">
        <div class="search-container">
            <input type="text" id="patientSearchIn" placeholder="Enter Patient Name or ID to fetch billing status..." onkeyup="searchPatientBill()">
        </div>
        <div id="searchResultArea">
            <div class="card" style="text-align: center; color: var(--text-dim); padding: 60px;">
                <div style="font-size: 40px; margin-bottom: 20px;">üîç</div>
                Initialize search to retrieve clinical records and ledger status.
            </div>
        </div>
    </div>

    <!-- LABORATORY MODULE -->
    <div id="labSec" class="content-sec hidden">
        <div class="card">
            <h2>Diagnostic Laboratory Services</h2>
            <div class="grid-3" style="margin-top: 30px;">
                <select id="labPatientSelect"></select>
                <select id="labTestType">
                    <option value="1200">Full Blood Count (Rs 1,200)</option>
                    <option value="2500">X-Ray Imaging (Rs 2,500)</option>
                    <option value="9500">MRI Neuro Scan (Rs 9,500)</option>
                    <option value="3000">ECG Synchronized Analysis (Rs 3,000)</option>
                    <option value="15000">Full Body Bio-Scan (Rs 15,000)</option>
                </select>
                <button class="btn-primary" onclick="assignLabBill()">Execute Lab Charge</button>
            </div>
        </div>
        <div class="card" id="labLog">
            <h3>Laboratory Workflow Queue</h3>
            <div id="labQueueList"></div>
        </div>
    </div>

    <!-- FEATURES SECTION -->
    <div id="featureSec" class="content-sec hidden">
        <div class="card">
            <h1 style="font-size: 40px; font-weight: 800; letter-spacing: -2px; margin-bottom: 40px;">System Specifications</h1>
            <div class="grid-3">
                <div class="card" style="background: rgba(59, 130, 246, 0.05); border-left: 6px solid var(--accent);">
                    <h3>üß† Neural Diagnostics</h3>
                    <p style="color: var(--text-dim); font-size: 14px; margin-top: 10px;">Predictive AI tracking vitals for critical complication prevention.</p>
                </div>
                <div class="card" style="background: rgba(16, 185, 129, 0.05); border-left: 6px solid var(--success);">
                    <h3>ü¶æ Robotic Surgery</h3>
                    <p style="color: var(--text-dim); font-size: 14px; margin-top: 10px;">Sub-millimeter precision via DaVinci-grade autonomous units.</p>
                </div>
                <div class="card" style="background: rgba(245, 158, 11, 0.05); border-left: 6px solid var(--warning);">
                    <h3>üß¨ Genomic Mapping</h3>
                    <p style="color: var(--text-dim); font-size: 14px; margin-top: 10px;">DNA-mapped medicinal delivery tailored to patient biology.</p>
                </div>
                <div class="card" style="background: rgba(14, 165, 233, 0.05); border-left: 6px solid var(--info);">
                    <h3>üöÅ Drone Med-Evac</h3>
                    <p style="color: var(--text-dim); font-size: 14px; margin-top: 10px;">Sub-orbital trauma retrieval within a 15-mile node radius.</p>
                </div>
                <div class="card" style="background: rgba(239, 68, 68, 0.05); border-left: 6px solid var(--danger);">
                    <h3>üõ°Ô∏è Quantum Privacy</h3>
                    <p style="color: var(--text-dim); font-size: 14px; margin-top: 10px;">4096-bit biometric encryption for all clinical data nodes.</p>
                </div>
                <div class="card" style="background: rgba(248, 250, 252, 0.03); border-left: 6px solid #fff;">
                    <h3>üõå Bio-Sync Beds</h3>
                    <p style="color: var(--text-dim); font-size: 14px; margin-top: 10px;">Smart frequency beds accelerating cell recovery by 40%.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GALLERY SECTION -->
    <div id="gallerySec" class="content-sec hidden">
        <div class="card">
            <h2>Hospital Gallery - Facility Visual Tour</h2>
            <div class="gallery-grid" id="galleryMount" style="margin-top: 30px;">
                <!-- AUTO GENERATED (20 PHOTOS) -->
            </div>
        </div>
    </div>

    <!-- INTAKE ENGINE -->
    <div id="admitSec" class="content-sec hidden">
        <div class="card">
            <h2>Patient Intake Engine (Enhanced Logic)</h2>
            <div class="grid-3" style="margin-top: 30px;">
                <select id="pVisitType" onchange="toggleAdmitFields()">
                    <option value="admit">Full In-Patient Admission</option>
                    <option value="checkup">OPD Consultation</option>
                    <option value="emergency">üö® EMERGENCY TRAUMA UNIT</option>
                </select>
                <input type="text" id="pName" placeholder="Legal Full Name">
                <input type="number" id="pAge" placeholder="Chronological Age">
            </div>
            <div class="grid-3">
                <select id="pGender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-Binary">Non-Binary</option>
                </select>
                <input type="number" id="pDeposit" placeholder="Initial Advance (Rs)" value="0">
                <input type="text" id="pSymptoms" placeholder="Symptoms Analysis" onkeyup="analyzeSymptoms()">
            </div>
            <div class="grid-3" id="admitOnlyFields">
                <select id="pRoom">
                    <option value="2500">General Ward (2,500/day)</option>
                    <option value="8500">Private Glass Suite (8,500/day)</option>
                    <option value="18000">Intensive Care Unit (18,000/day)</option>
                    <option value="35000">Emergency Trauma Suite (35,000/day)</option>
                </select>
                <select id="pDoctorAssign">
                    <option value="Not Assigned">Select Attending Physician...</option>
                </select>
            </div>
            <div style="margin: 10px 0; font-size: 14px; color: var(--accent); font-weight: 800; display: flex; align-items: center; gap: 10px;" id="clinicSuggestion"></div>
            <textarea id="pClinicalNotes" style="height: 150px;" placeholder="Comprehensive Clinical Notes, Vital Observations, and Medical History..."></textarea>
            <button class="btn-primary" style="width: auto;" onclick="admitPatient()">Finalize Node Entry</button>
        </div>
        <div class="card">
            <h3>Active Clinical Status Matrix</h3>
            <div id="activePatientsList"></div>
        </div>
    </div>

    <!-- PHARMACY MODULE -->
    <div id="pharmaSec" class="content-sec hidden">
        <div class="card">
            <h2>Pharma Logistics & Drug Repository</h2>
            <div class="grid-3" style="margin-top: 30px;">
                <input type="text" id="medName" placeholder="Medication UID">
                <input type="number" id="medStock" placeholder="Available Units">
                <input type="number" id="medPrice" placeholder="Unit Fiscal Value (Rs)">
            </div>
            <button class="btn-primary" style="background: var(--success); width: auto;" onclick="addInventory()">Commit to Inventory</button>
        </div>

        <div class="card">
            <h2>Assign Medication Charge</h2>
            <div id="pharmaPrescriptionView" style="margin-bottom: 20px; color: var(--warning); font-weight: 800; background: rgba(0,0,0,0.4); padding: 15px; border-radius: 12px; display: none; border-left: 5px solid var(--warning);"></div>
            <div class="grid-3">
                <select id="pharmaPatientSelect" onchange="showPharmaPrescription()"></select>
                <input type="text" id="pharmaMedTitle" placeholder="Medication Identifier">
                <input type="number" id="pharmaMedCost" placeholder="Total Node Cost (Rs)">
            </div>
            <button class="btn-primary" style="width: auto;" onclick="assignMedicineBill()">Execute Charge</button>
        </div>

        <div class="card" id="inventoryList"></div>
    </div>

    <!-- FINANCE MODULE -->
    <div id="financeSec" class="content-sec hidden">
        <div class="card">
            <h1 style="font-size: 40px; font-weight: 800; letter-spacing: -2px; margin-bottom: 40px;">Global Fiscal Command</h1>
            <div id="pnlData">
                <div class="grid-3">
                    <div class="card" style="background: rgba(255, 255, 255, 0.03); text-align: center;">
                        <small style="text-transform: uppercase; letter-spacing: 2px;">Gross Collected Revenue</small>
                        <h2 id="fin-total-rev" style="color: var(--success); font-size: 42px;">Rs 0</h2>
                    </div>
                    <div class="card" style="background: rgba(255, 255, 255, 0.03); text-align: center;">
                        <small style="text-transform: uppercase; letter-spacing: 2px;">Professional Payouts</small>
                        <h2 id="fin-total-comm" style="color: var(--warning); font-size: 42px;">Rs 0</h2>
                    </div>
                    <div class="card" style="background: rgba(255, 255, 255, 0.03); text-align: center;">
                        <small style="text-transform: uppercase; letter-spacing: 2px;">Net Node Profit</small>
                        <h2 id="fin-net-profit" style="color: var(--accent); font-size: 42px;">Rs 0</h2>
                    </div>
                </div>
            </div>
            <button class="btn-primary btn-danger" style="margin-top: 40px; border: none; background: var(--danger);" onclick="resetFinances()">CRITICAL: WIPE ALL FISCAL DATA</button>
        </div>
    </div>

    <!-- STAFF BREAK ROOM -->
    <div id="gameSec" class="content-sec hidden">
        <div class="card" style="text-align: center;">
            <h1 style="font-size: 40px; font-weight: 800; letter-spacing: -2px; margin-bottom: 40px;">Staff Reflex Training</h1>
            <canvas id="snakeGame" width="500" height="500" style="background:#000; border: 4px solid var(--accent); border-radius: 40px; margin: 0 auto; display: block;"></canvas>
            <h2 style="color: var(--accent); margin-top: 30px; font-size: 32px;">SCORE: <span id="snakeScore">0</span></h2>
        </div>
    </div>

</div>

<!-- 
    ==================================================================================
    CORE INTELLIGENCE ENGINE v19.0
    ==================================================================================
-->
<script>
/**
 * HMS GLOBAL DATABASE & CONFIG
 */
const SYSTEM_AUTH_KEYS = [
    { u: "admin", p: "admin123", role: "admin", name: "System Administrator" },
    { u: "doc1", p: "123", role: "doctor", name: "Dr. Alexander" },
    { u: "pharm1", p: "pharm123", role: "pharmacist", name: "Lead Pharmacist" },
    { u: "user1", p: "0000", role: "patient", name: "Patient Portal" }
];

const GALLERY_SOURCE = [
    "https://images.unsplash.com/photo-1519494026892-80bbd2d6fd0d", "https://images.unsplash.com/photo-1516549655169-df83a0774514",
    "https://images.unsplash.com/photo-1586773860418-d37222d8fce2", "https://images.unsplash.com/photo-1512678080530-7760d81faba6",
    "https://images.unsplash.com/photo-1551076805-e1869033e561", "https://images.unsplash.com/photo-1579684385127-1ef15d508118",
    "https://images.unsplash.com/photo-1581594632702-f235ae89b022", "https://images.unsplash.com/photo-1505751172107-57324a0834d8",
    "https://images.unsplash.com/photo-1538108197017-c1c9868bb2e3", "https://images.unsplash.com/photo-1516574187841-cb9cc2ca948b",
    "https://images.unsplash.com/photo-1527613426441-4da17471b66d", "https://images.unsplash.com/photo-1504813184591-01572f98c85f",
    "https://images.unsplash.com/photo-1512102438733-bfa4ed29aef7", "https://images.unsplash.com/photo-1631217818202-90ef4a8a0593",
    "https://images.unsplash.com/photo-1666214280557-f1b5022eb634", "https://images.unsplash.com/photo-1532938911079-1b06ac7ceec7",
    "https://images.unsplash.com/photo-1513224502586-d1e602410265", "https://images.unsplash.com/photo-1526256262350-7da7584cf5eb",
    "https://images.unsplash.com/photo-1551601651-0a30d973273c", "https://images.unsplash.com/photo-1530497610245-94d3c16cda28"
];

let currentUser = null;

/**
 * UTILITY: SYSTEM TOAST NOTIFICATIONS
 */
function showToast(msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${type === 'success' ? 'üõ°Ô∏è' : '‚ö†Ô∏è'}</span> ${msg}`;
    container.appendChild(toast);
    setTimeout(() => { 
        toast.style.opacity = '0'; 
        toast.style.transform = 'translateX(100px)'; 
        setTimeout(() => toast.remove(), 600); 
    }, 3500);
}

/**
 * AUTHENTICATION MODULE (Enhanced RBAC)
 */
function handleLogin() {
    const u = document.getElementById('userIn').value;
    const p = document.getElementById('passIn').value;
    const found = SYSTEM_AUTH_KEYS.find(x => x.u === u && x.p === p);

    if (found) {
        currentUser = found;
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('main').classList.remove('hidden');
        
        document.getElementById('displayUser').innerText = found.name;
        document.getElementById('displayRole').innerText = found.role.toUpperCase() + "_COMMAND";
        
        applyRBAC(found.role);
        
        // FIX: AUDIT LOGS FOR EVERY LOGIN
        logAudit(`SEC_EVENT: Authentication successful for [${found.u}] | ROLE: ${found.role}`);
        
        showToast(`Uplink Synchronized. Welcome ${found.name}`, 'info');
        initSystem();
    } else {
        document.getElementById('loginMsg').innerText = "FATAL: Biometric Mismatch Detected. Access Denied.";
    }
}

function applyRBAC(role) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.add('hidden'));
    
    if (role === 'admin') {
        document.querySelectorAll('.role-admin, .role-doctor, .role-pharmacist, .role-patient').forEach(el => el.classList.remove('hidden'));
        nav('dashSec', document.getElementById('nav-dash'));
    } 
    else if (role === 'doctor') {
        document.querySelectorAll('.role-doctor, .role-patient').forEach(el => el.classList.remove('hidden'));
        nav('admitSec', document.getElementById('nav-admit'));
    } 
    else if (role === 'pharmacist') {
        document.querySelectorAll('.role-pharmacist, .role-patient').forEach(el => el.classList.remove('hidden'));
        nav('pharmaSec', document.getElementById('nav-pharma'));
    } 
    else if (role === 'patient') {
        document.querySelectorAll('.role-patient').forEach(el => el.classList.remove('hidden'));
        nav('patientPortalSec', document.getElementById('nav-search'));
    }
}

/**
 * SYSTEM INITIALIZATION
 */
function initSystem() {
    initChart();
    renderGallery();
    updateUI();
    populateDoctorDropdown();
    refreshPharmaPatientList();
    refreshLabPatientList();
}

/**
 * REVENUE ENGINE: THE ABSOLUTE NON-NEGATIVE PROTECTION
 */
function calculateLiveBill(p) {
    let sub = 0;
    const consult = Math.max(0, parseInt(p.consultFee) || 0);
    const meds = Math.max(0, parseInt(p.meds) || 0);
    const lab = Math.max(0, parseInt(p.labCharges) || 0);
    const room = Math.max(0, parseInt(p.roomTypePrice) || 0);
    const deposit = Math.max(0, parseInt(p.deposit) || 0);

    if (p.visitType === 'checkup') {
        sub = consult + meds + lab;
    } else {
        const admitTime = new Date(p.admitDate);
        const currentTime = new Date();
        const diffDays = Math.ceil((currentTime - admitTime) / (1000 * 60 * 60 * 24)) || 1;
        sub = (diffDays * room) + meds + consult + lab;
    }

    const tax = sub * 0.18;
    const gross = sub + tax;
    
    // ABSOLUTE FIX: Revenue cannot be negative. If credit > bill, balance is 0.
    const due = Math.max(0, gross - deposit);
    
    return { sub, tax, gross, due, total: due };
}

/**
 * NAVIGATION MODULE
 */
function nav(id, el) {
    document.querySelectorAll('.content-sec').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
    if (el) el.classList.add('active-nav');
    
    if (id === 'gameSec') initSnake();
    if (id === 'financeSec') updateFinanceDashboard();
    if (id === 'billingSec') searchPatientBill();
}

/**
 * HR MODULE: PERSONNEL MANAGEMENT
 */
function toggleStaffFields() {
    const role = document.getElementById('stRole').value;
    document.getElementById('doctorSpecificInputs').style.display = (role.includes('Doctor') || role.includes('Surgeon')) ? 'grid' : 'none';
}

function addStaff() {
    const n = document.getElementById('stName').value;
    const r = document.getElementById('stRole').value;
    const s = document.getElementById('stSalary').value;
    const f = document.getElementById('stConsultCharge').value || 0;
    
    if (!n || !s) return showToast("Data Integrity Error: Missing Fields", "danger");

    let staff = JSON.parse(localStorage.getItem('hms_staff_v19')) || [];
    staff.push({ 
        id: Date.now(), 
        name: n, 
        role: r, 
        salary: parseInt(s) || 0, 
        consultFee: parseInt(f) || 0, 
        totalCommission: 0 
    });
    localStorage.setItem('hms_staff_v19', JSON.stringify(staff));
    
    logAudit(`HR_EVENT: ${n} (${r}) registered. Basic: Rs ${s}`);
    showToast(`${n} Synchronized to System`);
    
    // Auto-Reset
    document.getElementById('stName').value = "";
    document.getElementById('stSalary').value = "";
    renderStaff();
    populateDoctorDropdown();
}

function renderStaff() {
    let staff = JSON.parse(localStorage.getItem('hms_staff_v19')) || [];
    let html = `<table><tr><th>Professional Node</th><th>Designation</th><th>Earnings (Comm)</th><th>Action</th></tr>`;
    staff.forEach(x => {
        html += `<tr>
            <td>${x.name}</td>
            <td>${x.role}</td>
            <td style="color:var(--success); font-weight:bold;">Rs ${(x.totalCommission || 0).toLocaleString()}</td>
            <td>
                <button onclick="removeStaff(${x.id})" style="background:var(--danger); padding:8px 15px; border:none; color:white; border-radius:10px; cursor:pointer;">TERMINATE</button>
            </td>
        </tr>`;
    });
    document.getElementById('staffList').innerHTML = html + "</table>";
}

function removeStaff(id) {
    let staff = JSON.parse(localStorage.getItem('hms_staff_v19')) || [];
    staff = staff.filter(x => x.id !== id);
    localStorage.setItem('hms_staff_v19', JSON.stringify(staff));
    renderStaff();
    populateDoctorDropdown();
}

/**
 * CLINICAL INTAKE MODULE
 */
function toggleAdmitFields() {
    const type = document.getElementById('pVisitType').value;
    const roomSelect = document.getElementById('pRoom');
    if (type === 'checkup') {
        roomSelect.disabled = true;
        roomSelect.style.opacity = '0.3';
    } else {
        roomSelect.disabled = false;
        roomSelect.style.opacity = '1';
        if (type === 'emergency') roomSelect.value = "35000";
    }
}

function analyzeSymptoms() {
    const sym = document.getElementById('pSymptoms').value.toLowerCase();
    const hint = document.getElementById('clinicSuggestion');
    
    const rules = [
        { key: ['chest', 'heart', 'breath'], msg: "üö® Cardiology / Trauma Unit Suggested" },
        { key: ['bone', 'fracture', 'joint'], msg: "ü¶¥ Orthopedic Unit Suggested" },
        { key: ['fever', 'cough', 'viral'], msg: "üå°Ô∏è General Medicine Node Suggested" },
        { key: ['head', 'seizure', 'vision'], msg: "üß† Neurology Assessment Required" }
    ];

    let found = rules.find(r => r.key.some(k => sym.includes(k)));
    hint.innerText = found ? found.msg : "";
}

function populateDoctorDropdown() {
    let staff = JSON.parse(localStorage.getItem('hms_staff_v19')) || [];
    let docs = staff.filter(s => s.role.includes('Doctor') || s.role.includes('Surgeon'));
    let select = document.getElementById('pDoctorAssign');
    if(!select) return;
    select.innerHTML = '<option value="Not Assigned">Assign Physician...</option>';
    docs.forEach(d => {
        let opt = document.createElement('option');
        opt.value = d.name;
        opt.innerHTML = `${d.name} (${d.role})`;
        select.appendChild(opt);
    });
}

function admitPatient() {
    const name = document.getElementById('pName').value;
    const docName = document.getElementById('pDoctorAssign').value;
    if (!name || docName === "Not Assigned") return showToast("Clinical Profile Incomplete", "danger");

    let staff = JSON.parse(localStorage.getItem('hms_staff_v19')) || [];
    let doctor = staff.find(s => s.name === docName);
    let fee = doctor ? (parseInt(doctor.consultFee) || 0) : 0;

    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    const entry = {
        id: Date.now(),
        name: name,
        age: document.getElementById('pAge').value,
        gender: document.getElementById('pGender').value,
        visitType: document.getElementById('pVisitType').value,
        symptoms: document.getElementById('pSymptoms').value,
        roomTypePrice: document.getElementById('pVisitType').value === 'checkup' ? 0 : (parseInt(document.getElementById('pRoom').value) || 0),
        consultFee: fee,
        deposit: parseInt(document.getElementById('pDeposit').value) || 0,
        labCharges: 0,
        admitDate: new Date().toISOString(),
        notes: document.getElementById('pClinicalNotes').value,
        assignedDoctor: docName,
        meds: 0,
        status: 'active'
    };
    p.push(entry);
    localStorage.setItem('hms_patients_v19', JSON.stringify(p));
    
    logAudit(`CLINIC: Node admitted [${name}]. Assigned to Dr. ${docName}`);
    showToast(`Intake Complete: Node Synchronized`);
    
    // Reset Form
    ['pName', 'pAge', 'pDeposit', 'pSymptoms', 'pClinicalNotes'].forEach(id => document.getElementById(id).value = "");
    updateUI();
}

/**
 * FISCAL SETTLEMENT MODULE
 */
function searchPatientBill() {
    const query = document.getElementById('patientSearchIn').value.toLowerCase();
    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let results = p.filter(x => (x.name.toLowerCase().includes(query) || x.id.toString().includes(query)) && x.status === 'active');

    let html = "";
    if (results.length > 0 && query !== "") {
        results.forEach(x => {
            let bill = calculateLiveBill(x);
            
            let settlementBtn = currentUser.role === 'admin' ? 
                `<button class="btn-primary" style="margin-top:20px; background:var(--success);" onclick="dischargePatient(${x.id})">EXECUTE SETTLEMENT & DISCHARGE</button>` : 
                `<div style="margin-top:20px; padding:15px; background:rgba(245, 158, 11, 0.1); color:var(--warning); border-radius:12px; font-weight:800;">PENDING_ADMIN_FINALIZATION</div>`;

            html += `
            <div class="card">
                <div class="grid-3">
                    <div><small>Identity Node</small><h3>${x.name}</h3></div>
                    <div><small>Intake Mode</small><h3 style="color:var(--warning)">${x.visitType.toUpperCase()}</h3></div>
                    <div><small>Settlement Outstanding</small><h2 style="color:var(--accent); font-family:'JetBrains Mono'">Rs ${bill.total.toLocaleString()}</h2></div>
                </div>
                <hr style="border:0; border-top:1px solid var(--glass-border); margin:25px 0;">
                <p><strong>Clinical Note:</strong> ${x.notes || "None recorded"}</p>
                <div class="grid-3" style="margin-top:20px;">
                    <span>Bio-Tax (18%): Rs ${bill.tax.toFixed(2)}</span>
                    <span>Service Flux: Rs ${bill.sub.toFixed(2)}</span>
                    <span>Advance Node: Rs ${x.deposit.toLocaleString()}</span>
                </div>
                ${settlementBtn}
            </div>`;
        });
    } else if (query !== "") {
        html = `<div class="card" style="text-align:center; padding:60px;">IDENTITY NOT FOUND IN ACTIVE WARD.</div>`;
    }
    document.getElementById('searchResultArea').innerHTML = html;
}

function dischargePatient(id) {
    if (currentUser.role !== 'admin') return;

    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let idx = p.findIndex(x => x.id == id);
    if (idx === -1) return;

    let bill = calculateLiveBill(p[idx]);
    
    // Node Payout Calculation (15% Facility Fee)
    let facilityFee = bill.sub * 0.15;
    let commission = (p[idx].consultFee * 0.85) + (bill.sub * 0.1); 

    let staff = JSON.parse(localStorage.getItem('hms_staff_v19')) || [];
    let docIdx = staff.findIndex(s => s.name === p[idx].assignedDoctor);
    if (docIdx !== -1) {
        staff[docIdx].totalCommission = (staff[docIdx].totalCommission || 0) + commission;
        localStorage.setItem('hms_staff_v19', JSON.stringify(staff));
    }

    let totalRev = parseFloat(localStorage.getItem('hms_fiscal_rev')) || 0;
    let totalComm = parseFloat(localStorage.getItem('hms_fiscal_payout')) || 0;
    
    localStorage.setItem('hms_fiscal_rev', totalRev + bill.total);
    localStorage.setItem('hms_fiscal_payout', totalComm + commission);

    p[idx].status = 'discharged';
    localStorage.setItem('hms_patients_v19', JSON.stringify(p));
    
    logAudit(`FINANCE: Settlement complete [${p[idx].name}]. Collected: Rs ${bill.total}`);
    
    triggerDigitalInvoice(p[idx], bill);
    updateUI();
    searchPatientBill();
}

function triggerDigitalInvoice(p, b) {
    const text = `
    INVOICE_UID: ${p.id.toString().slice(-10)}
    NODE_NAME:   ${p.name.toUpperCase()}
    PHYSICIAN:   DR. ${p.assignedDoctor.toUpperCase()}
    --------------------------------------------
    CONSULTATION:     Rs ${p.consultFee.toLocaleString()}
    LAB_DIAGNOSTICS:  Rs ${p.labCharges.toLocaleString()}
    PHARMA_LEDGER:    Rs ${p.meds.toLocaleString()}
    CLINICAL_STAY:    Rs ${(b.sub - p.consultFee - p.meds - p.labCharges).toFixed(2)}
    --------------------------------------------
    BIO_TAX (18%):    Rs ${b.tax.toFixed(2)}
    ADVANCE_CREDIT: - Rs ${p.deposit.toLocaleString()}
    --------------------------------------------
    FINAL_SETTLED:    Rs ${b.due.toLocaleString()}
    
    STATUS: [FULLY_DISCHARGED]
    `;
    document.getElementById('receiptPayload').innerText = text;
    document.getElementById('receiptModal').style.display = 'flex';
}

function closeReceipt() { document.getElementById('receiptModal').style.display = 'none'; }

/**
 * PHARMACY MODULE
 */
function refreshPharmaPatientList() {
    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let sel = document.getElementById('pharmaPatientSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">Target Patient Node...</option>';
    p.filter(x => x.status === 'active').forEach(x => {
        sel.innerHTML += `<option value="${x.id}">${x.name}</option>`;
    });
}

function addInventory() {
    const n = document.getElementById('medName').value;
    const s = document.getElementById('medStock').value;
    const p = document.getElementById('medPrice').value;
    if (!n || !s) return;

    let inv = JSON.parse(localStorage.getItem('hms_inv_v19')) || [];
    inv.push({ name: n, stock: parseInt(s), price: parseInt(p), date: new Date().toLocaleDateString() });
    localStorage.setItem('hms_inv_v19', JSON.stringify(inv));
    renderInventory();
    showToast("Inventory Matrix Updated", "success");
}

function renderInventory() {
    let inv = JSON.parse(localStorage.getItem('hms_inv_v19')) || [];
    let html = `<table><tr><th>Drug Identifier</th><th>Stock</th><th>Unit Price</th></tr>`;
    inv.forEach(x => html += `<tr><td>${x.name}</td><td>${x.stock} Units</td><td>Rs ${x.price}</td></tr>`);
    document.getElementById('inventoryList').innerHTML = html + "</table>";
}

function assignMedicineBill() {
    const pid = document.getElementById('pharmaPatientSelect').value;
    const cost = parseInt(document.getElementById('pharmaMedCost').value) || 0;
    if (!pid || cost === 0) return showToast("Vector Error: Missing Data", "danger");

    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let idx = p.findIndex(x => x.id == pid);
    if (idx !== -1) {
        p[idx].meds = (parseInt(p[idx].meds) || 0) + cost;
        localStorage.setItem('hms_patients_v19', JSON.stringify(p));
        logAudit(`PHARMA: Medication charged to ${p[idx].name}`);
        showToast("Ledger Updated", "success");
        updateUI();
    }
}

/**
 * LAB MODULE
 */
function refreshLabPatientList() {
    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let sel = document.getElementById('labPatientSelect');
    if (!sel) return;
    sel.innerHTML = '<option value="">Diagnostic Target Node...</option>';
    p.filter(x => x.status === 'active').forEach(x => {
        sel.innerHTML += `<option value="${x.id}">${x.name}</option>`;
    });
}

function assignLabBill() {
    const pid = document.getElementById('labPatientSelect').value;
    const cost = parseInt(document.getElementById('labTestType').value) || 0;
    if (!pid) return showToast("Select a patient.", "danger");

    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let idx = p.findIndex(x => x.id == pid);
    if (idx !== -1) {
        p[idx].labCharges = (parseInt(p[idx].labCharges) || 0) + cost;
        localStorage.setItem('hms_patients_v19', JSON.stringify(p));
        logAudit(`LAB: Bio-Diagnostic test assigned to ${p[idx].name}`);
        showToast("Lab Fee Executed", "success");
        updateUI();
    }
}

/**
 * FISCAL COMMAND & DASHBOARD
 */
function initChart() {
    const canvas = document.getElementById('revenueChart');
    if (!canvas) return;
    new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: ['Node_A', 'Node_B', 'Node_C', 'Node_D', 'Node_E'],
            datasets: [{
                label: 'System Flux',
                data: [45, 82, 61, 115, 98],
                borderColor: '#3b82f6',
                tension: 0.5,
                fill: true,
                backgroundColor: 'rgba(59, 130, 246, 0.08)'
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
    });
}

function renderGallery() {
    const mount = document.getElementById('galleryMount');
    mount.innerHTML = GALLERY_SOURCE.map((url, i) => `
        <div class="gallery-item">
            <img src="${url}?auto=format&fit=crop&q=80&w=600" alt="Facility_Node_${i}">
            <div class="gallery-label">NODE_00${i+1}</div>
        </div>
    `).join('');
}

function logAudit(msg) {
    let logs = JSON.parse(localStorage.getItem('hms_audit_v19')) || [];
    logs.push(`> [${new Date().toLocaleTimeString()}] ${msg}`);
    localStorage.setItem('hms_audit_v19', JSON.stringify(logs.slice(-50)));
    const container = document.getElementById('auditContainer');
    if (container) container.innerHTML = logs.reverse().join('<br>');
}

function updateFinanceDashboard() {
    let rev = parseFloat(localStorage.getItem('hms_fiscal_rev')) || 0;
    let payout = parseFloat(localStorage.getItem('hms_fiscal_payout')) || 0;
    document.getElementById('fin-total-rev').innerText = "Rs " + rev.toLocaleString();
    document.getElementById('fin-total-comm').innerText = "Rs " + payout.toLocaleString();
    document.getElementById('fin-net-profit').innerText = "Rs " + Math.max(0, (rev - payout)).toLocaleString();
}

function resetFinances() {
    if (confirm("CRITICAL: Wipe all fiscal telemetry data?")) {
        localStorage.setItem('hms_fiscal_rev', '0');
        localStorage.setItem('hms_fiscal_payout', '0');
        updateUI();
        logAudit("ADMIN: Global financial reset executed.");
    }
}

function updateUI() {
    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let active = p.filter(x => x.status === 'active');
    document.getElementById('stat-p').innerText = active.length;
    
    let currentLiveTotal = active.reduce((a, b) => a + calculateLiveBill(b).total, 0);
    document.getElementById('stat-profit').innerText = "Rs " + currentLiveTotal.toLocaleString();
    
    renderPatientTable();
    renderInventory();
    renderStaff();
    updateFinanceDashboard();
    refreshPharmaPatientList();
    refreshLabPatientList();
}

function renderPatientTable() {
    let p = JSON.parse(localStorage.getItem('hms_patients_v19')) || [];
    let active = p.filter(x => x.status === 'active');
    let html = `<table><tr><th>Identity Node</th><th>Physician</th><th>Due (Rs)</th></tr>`;
    active.forEach(x => {
        let b = calculateLiveBill(x);
        html += `<tr><td>${x.name}</td><td>${x.assignedDoctor}</td><td style="color:var(--accent); font-weight:800;">Rs ${b.due.toLocaleString()}</td></tr>`;
    });
    document.getElementById('activePatientsList').innerHTML = html + "</table>";
}

function logout() { location.reload(); }

/**
 * STAFF LOUNGE: SNAKE REFLEX SIMULATION
 */
function initSnake() {
    const canvas = document.getElementById("snakeGame");
    const ctx = canvas.getContext("2d");
    let box = 25, score = 0, dir, game;
    let snake = [{x: 10 * box, y: 10 * box}];
    let food = { x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box };

    document.onkeydown = e => {
        if(e.keyCode == 37 && dir != "RIGHT") dir = "LEFT";
        else if(e.keyCode == 38 && dir != "DOWN") dir = "UP";
        else if(e.keyCode == 39 && dir != "LEFT") dir = "RIGHT";
        else if(e.keyCode == 40 && dir != "UP") dir = "DOWN";
    };

    function draw() {
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, 500, 500);
        for(let i = 0; i < snake.length; i++) {
            ctx.fillStyle = (i == 0) ? "#3b82f6" : "#1e293b";
            ctx.fillRect(snake[i].x, snake[i].y, box, box);
        }
        ctx.fillStyle = "#ef4444"; ctx.fillRect(food.x, food.y, box, box);
        let headX = snake[0].x, headY = snake[0].y;
        if(dir == "LEFT") headX -= box; if(dir == "UP") headY -= box;
        if(dir == "RIGHT") headX += box; if(dir == "DOWN") headY += box;
        if(headX == food.x && headY == food.y) {
            score++; document.getElementById('snakeScore').innerText = score;
            food = { x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box };
        } else snake.pop();
        let nH = {x: headX, y: headY};
        if(headX < 0 || headX >= 500 || headY < 0 || headY >= 500) { clearInterval(game); showToast("Simulation Failed. Final Reflex: " + score, "danger"); }
        snake.unshift(nH);
    }
    game = setInterval(draw, 100);
}
</script>
</body>
</html>